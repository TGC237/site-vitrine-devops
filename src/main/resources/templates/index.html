<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TGC-SITE | Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="p-4 md:p-8 bg-[#0B0F1A] text-slate-200">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <nav class="glass p-6 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center font-bold shadow-lg shadow-blue-500/20">TGC</div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight">MISSION CONTROL</h1>
                    <p class="text-[10px] text-blue-400 font-mono tracking-widest uppercase">Operator: DevSecOps Engineer</p>
                </div>
            </div>
            <div class="flex gap-4 md:gap-6 text-[10px] md:text-sm font-medium text-slate-400 overflow-x-auto no-scrollbar pb-2 md:pb-0">
                <a href="javascript:void(0)" onclick="loadModule('dashboard')" class="hover:text-blue-400 transition-colors uppercase whitespace-nowrap">Dashboard</a>
                <a href="javascript:void(0)" onclick="loadModule('profil')" class="hover:text-blue-400 transition-colors uppercase whitespace-nowrap">Profil</a>
                <a href="javascript:void(0)" onclick="loadModule('experiences')" class="hover:text-blue-400 transition-colors uppercase whitespace-nowrap">Expériences</a>
                <a href="javascript:void(0)" onclick="loadModule('projets')" class="hover:text-blue-400 transition-colors uppercase whitespace-nowrap">Projets</a>
                <a href="javascript:void(0)" onclick="loadModule('contact')" class="hover:text-blue-400 transition-colors uppercase whitespace-nowrap">Contact</a>
            </div>
        </nav>

        <main id="main-display" class="transition-all duration-500 opacity-100 translate-y-0 min-h-[400px]">
            <div class="flex flex-col items-center justify-center py-20 space-y-4">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                <p class="text-xs font-mono text-slate-500 uppercase tracking-widest">Initialisation du système...</p>
            </div>
        </main>
    </div>

    <script>
        // --- LOGIQUE DE MONITORING (Garde tes données vivantes) ---
        async function updateMissionControl() {
            try {
                const response = await fetch('/data/mission_control.json?t=' + Date.now());
                const rawData = await response.json();
                const data = Array.isArray(rawData) ? rawData[0] : rawData;
                if (!data) return;

                // Mise à jour sécurisée : on vérifie si l'ID existe avant d'écrire
                const updateIfExist = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = value;
                };

                updateIfExist('jenkins-info', `#${data.jenkinsBuildNumber || 0} - ${data.jenkinsStatus || 'STABLE'}`);
                updateIfExist('ram-usage', `${data.ramUsageGb || '0'} GB`);
                updateIfExist('latency-val', `${Math.floor(Math.random() * (45 - 12) + 12)} ms`);
		
		// --- MISE À JOUR DU HEARTBEAT (L'HEURE) ---
	        // C'est cette ligne qui remplace "Waiting for heartbeat..."
	        updateIfExist('last-update', `Last heartbeat: ${new Date().toLocaleTimeString()}`);
                
                const siteBadge = document.getElementById('site-status-badge');
                if (siteBadge) {
                    siteBadge.innerText = `SITES: ${data.siteStatus}`;
                    siteBadge.className = data.siteStatus === 'ALL ONLINE' 
                        ? "text-[10px] px-2 py-1 rounded border font-bold bg-emerald-500/10 text-emerald-400 border-emerald-500/20"
                        : "text-[10px] px-2 py-1 rounded border font-bold bg-red-500/10 text-red-400 border-red-500/20";
                }

                lucide.createIcons();
            } catch (e) { console.error("Erreur de synchronisation", e); }
        }

        // --- MOTEUR DE NAVIGATION (Injection de fragments) ---
        async function loadModule(name) {
            const main = document.getElementById('main-display');
            if (!main) return;

            // Transition de sortie
            main.classList.add('opacity-0', 'translate-y-4');

            // Gestion visuelle du menu actif
            document.querySelectorAll('nav a').forEach(link => {
                const isActive = link.getAttribute('onclick').includes(name);
                link.classList.toggle('text-blue-400', isActive);
                link.classList.toggle('font-bold', isActive);
                link.classList.toggle('text-slate-400', !isActive);
            });

            try {
                // On va chercher le fragment HTML sur le serveur
                const response = await fetch(`/fragments/${name}`);
                if (!response.ok) throw new Error('Fragment introuvable');
                const html = await response.text();
                
                setTimeout(() => {
                    main.innerHTML = html; // Injection !
                    main.classList.remove('opacity-0', 'translate-y-4'); // Transition d'entrée
                    lucide.createIcons(); // Recréation des icônes pour le nouveau contenu
                    
                    // Si on charge le dashboard, on force une mise à jour immédiate des datas
                    if (name === 'dashboard') updateMissionControl();
                }, 300);
            } catch (e) {
                console.error("Erreur de chargement :", e);
                main.innerHTML = `<div class="glass p-10 text-center text-red-400 font-mono italic">ERREUR_SYSTEME: LE MODULE [${name.toUpperCase()}] N'A PAS PU ÊTRE CHARGÉ.</div>`;
                main.classList.remove('opacity-0');
            }
        }

        // --- INITIALISATION AU CHARGEMENT DE LA PAGE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadModule('dashboard'); // On charge le Dashboard par défaut (l'accueil)
            setInterval(updateMissionControl, 30000); // Monitoring toutes les 30s
        });
    </script>
</body>
</html>
